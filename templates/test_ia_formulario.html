<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test IA Formulario</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>🧪 Test IA Formulario</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>Registrar Nueva Atención de Salud</h5>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label for="tipoAtencion" class="form-label">
                                    <i class="fas fa-stethoscope me-2 text-info"></i>
                                    Tipo de Atención
                                    <span class="badge bg-info ms-2">IA Considerada</span>
                                </label>
                                <select class="form-select" id="tipoAtencion" required onchange="actualizarAnalisisConTipoAtencion()">
                                    <option value="">Seleccionar...</option>
                                    <option value="medicina_general">Medicina General / Medicina Familiar</option>
                                    <option value="fisioterapia">Fisioterapia / Fisio</option>
                                    <option value="kinesiologia">Kinesiología / Kinesio</option>
                                    <option value="terapia_ocupacional">Terapia Ocupacional / Ergoterapia</option>
                                    <option value="enfermeria">Enfermería</option>
                                    <option value="psicologia">Psicología / Psicoterapia</option>
                                    <option value="nutricion">Nutrición / Dietética</option>
                                    <option value="fonoaudiologia">Fonoaudiología / Logopedia</option>
                                    <option value="urgencia">Urgencia / Emergencia</option>
                                </select>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    La IA ajustará las sugerencias según el tipo de atención seleccionado
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="motivoConsulta" class="form-label">
                                    <i class="fas fa-robot me-2 text-primary"></i>
                                    Motivo de la Atención
                                    <span class="badge bg-info ms-2">IA Asistida</span>
                                </label>
                                <textarea class="form-control" id="motivoConsulta" rows="3" 
                                        placeholder="Describe el motivo de la atención... La IA analizará automáticamente y sugerirá preguntas relevantes..." 
                                        required oninput="analizarMotivoEnTiempoReal()"></textarea>
                                
                                <!-- Indicador de análisis de IA -->
                                <div id="iaAnalysisIndicator" class="mt-2" style="display: none;">
                                    <div class="d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Analizando...</span>
                                        </div>
                                        <small class="text-primary">IA analizando motivo de consulta...</small>
                                    </div>
                                </div>
                                
                                <!-- Resultados del análisis de IA -->
                                <div id="iaAnalysisResults" class="mt-3" style="display: none;">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white py-2">
                                            <h6 class="mb-0">
                                                <i class="fas fa-robot me-2"></i>
                                                Análisis de IA
                                            </h6>
                                        </div>
                                        <div class="card-body p-3">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">Especialidad Detectada:</small>
                                                    <div class="fw-bold text-primary" id="especialidadDetectada">-</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">Categoría:</small>
                                                    <div class="fw-bold text-info" id="categoriaDetectada">-</div>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-md-6">
                                                    <small class="text-muted">Urgencia:</small>
                                                    <div class="fw-bold" id="urgenciaDetectada">-</div>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">Síntomas:</small>
                                                    <div class="fw-bold text-warning" id="sintomasDetectados">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="diagnostico" class="form-label">
                                    <i class="fas fa-clipboard-check me-2 text-success"></i>
                                    Evaluación/Observaciones
                                    <span class="badge bg-success ms-2">IA Sugerida</span>
                                </label>
                                <textarea class="form-control" id="diagnostico" rows="3" 
                                        placeholder="Evaluación inicial u observaciones relevantes... Las preguntas sugeridas por la IA aparecerán aquí..."></textarea>
                                
                                <!-- Preguntas sugeridas por IA -->
                                <div id="preguntasSugeridas" class="mt-3" style="display: none;">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white py-2">
                                            <h6 class="mb-0">
                                                <i class="fas fa-question-circle me-2"></i>
                                                Preguntas Sugeridas por IA
                                            </h6>
                                        </div>
                                        <div class="card-body p-3">
                                            <div id="listaPreguntasSugeridas"></div>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="insertarPreguntasEnEvaluacion()">
                                                    <i class="fas fa-plus me-1"></i>
                                                    Insertar Preguntas en Evaluación
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h6>Debug Info</h6>
                    </div>
                    <div class="card-body">
                        <div id="debugInfo">
                            <p><strong>Estado:</strong> <span id="estado">Esperando...</span></p>
                            <p><strong>Último motivo:</strong> <span id="ultimoMotivo">-</span></p>
                            <p><strong>Tipo atención:</strong> <span id="tipoAtencionDebug">-</span></p>
                            <p><strong>Log:</strong></p>
                            <div id="log" style="max-height: 200px; overflow-y: auto; font-size: 12px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales
        let ultimoMotivoAnalizado = '';
        let analisisTimeout = null;

        // Función para actualizar debug info
        function updateDebugInfo() {
            document.getElementById('estado').textContent = 'Activo';
            document.getElementById('ultimoMotivo').textContent = ultimoMotivoAnalizado || '-';
            document.getElementById('tipoAtencionDebug').textContent = document.getElementById('tipoAtencion').value || '-';
        }

        // Función para agregar log
        function addLog(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function analizarMotivoEnTiempoReal() {
            const motivoConsulta = document.getElementById('motivoConsulta').value.trim();
            const tipoAtencion = document.getElementById('tipoAtencion').value;

            addLog(`Analizando: "${motivoConsulta}" con tipo: "${tipoAtencion}"`);

            // Si el motivo está vacío, ocultar resultados
            if (!motivoConsulta) {
                ocultarResultadosIA();
                addLog('Motivo vacío, ocultando resultados');
                return;
            }

            // Si es el mismo motivo que ya analizamos, no hacer nada
            if (motivoConsulta === ultimoMotivoAnalizado) {
                addLog('Mismo motivo, saltando análisis');
                return;
            }

            // Mostrar indicador de análisis
            mostrarIndicadorAnalisis();
            addLog('Mostrando indicador de análisis');

            // Cancelar análisis anterior si existe
            if (analisisTimeout) {
                clearTimeout(analisisTimeout);
                addLog('Cancelando análisis anterior');
            }

            // Esperar 1 segundo antes de analizar (para evitar muchas llamadas)
            analisisTimeout = setTimeout(async () => {
                try {
                    addLog('Iniciando llamada a API...');
                    
                    const response = await fetch('/api/copilot/test-analyze-motivo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            motivo_consulta: motivoConsulta,
                            tipo_atencion: tipoAtencion
                        })
                    });

                    addLog(`Respuesta del servidor: ${response.status}`);

                    const data = await response.json();
                    addLog(`Datos recibidos: ${JSON.stringify(data)}`);

                    if (data.success) {
                        mostrarResultadosAnalisis(data.analisis);
                        ultimoMotivoAnalizado = motivoConsulta;
                        addLog('Análisis completado exitosamente');
                    } else {
                        console.error('❌ Error en análisis:', data.message);
                        mostrarErrorAnalisis(data.message);
                        addLog(`Error en análisis: ${data.message}`);
                    }

                } catch (error) {
                    console.error('❌ Error en análisis de IA:', error);
                    mostrarErrorAnalisis('Error de conexión con el servidor');
                    addLog(`Error de conexión: ${error.message}`);
                } finally {
                    ocultarIndicadorAnalisis();
                    addLog('Ocultando indicador de análisis');
                }
            }, 1000);

            updateDebugInfo();
        }

        // Función para mostrar el indicador de análisis
        function mostrarIndicadorAnalisis() {
            const indicator = document.getElementById('iaAnalysisIndicator');
            const results = document.getElementById('iaAnalysisResults');
            const preguntas = document.getElementById('preguntasSugeridas');

            if (indicator) indicator.style.display = 'block';
            if (results) results.style.display = 'none';
            if (preguntas) preguntas.style.display = 'none';
        }

        // Función para ocultar el indicador de análisis
        function ocultarIndicadorAnalisis() {
            const indicator = document.getElementById('iaAnalysisIndicator');
            if (indicator) indicator.style.display = 'none';
        }

        // Función para mostrar los resultados del análisis
        function mostrarResultadosAnalisis(analisis) {
            // Actualizar campos del análisis
            document.getElementById('especialidadDetectada').textContent =
                analisis.especialidad_detectada.replace('_', ' ').toUpperCase();
            document.getElementById('categoriaDetectada').textContent =
                analisis.categoria.toUpperCase();
            document.getElementById('urgenciaDetectada').textContent =
                analisis.urgencia;
            document.getElementById('sintomasDetectados').textContent =
                analisis.sintomas_principales.join(', ') || 'No detectados';

            // Mostrar resultados
            document.getElementById('iaAnalysisResults').style.display = 'block';

            // Mostrar preguntas sugeridas
            mostrarPreguntasSugeridas(analisis.preguntas_sugeridas);

            addLog('Resultados mostrados exitosamente');
        }

        // Función para mostrar las preguntas sugeridas
        function mostrarPreguntasSugeridas(preguntas) {
            const container = document.getElementById('listaPreguntasSugeridas');
            container.innerHTML = '';

            preguntas.forEach((pregunta, index) => {
                const preguntaDiv = document.createElement('div');
                preguntaDiv.className = 'mb-2';
                preguntaDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <button type="button" class="btn btn-outline-primary btn-sm me-2" 
                                onclick="insertarPreguntaEnEvaluacion('${pregunta.replace(/'/g, "\\'")}')">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div class="flex-grow-1">
                            <small class="text-muted">Pregunta ${index + 1}:</small>
                            <div class="fw-bold">${pregunta}</div>
                        </div>
                    </div>
                `;
                container.appendChild(preguntaDiv);
            });

            document.getElementById('preguntasSugeridas').style.display = 'block';
            addLog(`Mostradas ${preguntas.length} preguntas sugeridas`);
        }

        // Función para insertar una pregunta en la evaluación
        function insertarPreguntaEnEvaluacion(pregunta) {
            const evaluacionTextarea = document.getElementById('diagnostico');
            const preguntaFormateada = `• ${pregunta}\n`;
            
            if (evaluacionTextarea.value) {
                evaluacionTextarea.value += '\n' + preguntaFormateada;
            } else {
                evaluacionTextarea.value = preguntaFormateada;
            }
            
            addLog(`Pregunta insertada: ${pregunta}`);
        }

        // Función para insertar todas las preguntas
        function insertarPreguntasEnEvaluacion() {
            const evaluacionTextarea = document.getElementById('diagnostico');
            const preguntas = document.querySelectorAll('#listaPreguntasSugeridas .fw-bold');
            
            let preguntasTexto = '';
            preguntas.forEach(pregunta => {
                preguntasTexto += `• ${pregunta.textContent}\n`;
            });
            
            if (evaluacionTextarea.value) {
                evaluacionTextarea.value += '\n' + preguntasTexto;
            } else {
                evaluacionTextarea.value = preguntasTexto;
            }
            
            addLog('Todas las preguntas insertadas');
        }

        // Función para mostrar error
        function mostrarErrorAnalisis(mensaje) {
            addLog(`Error: ${mensaje}`);
            alert(`Error en análisis de IA: ${mensaje}`);
        }

        // Función para ocultar resultados
        function ocultarResultadosIA() {
            document.getElementById('iaAnalysisResults').style.display = 'none';
            document.getElementById('preguntasSugeridas').style.display = 'none';
        }

        // Función para actualizar análisis con tipo de atención
        function actualizarAnalisisConTipoAtencion() {
            const motivoConsulta = document.getElementById('motivoConsulta').value.trim();
            const tipoAtencion = document.getElementById('tipoAtencion').value;
            
            addLog(`Tipo de atención cambiado a: ${tipoAtencion}`);
            
            if (motivoConsulta && tipoAtencion) {
                ultimoMotivoAnalizado = ''; // Forzar re-análisis
                analizarMotivoEnTiempoReal();
            }
            
            updateDebugInfo();
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Página cargada, IA lista para usar');
            updateDebugInfo();
        });
    </script>
</body>
</html> 