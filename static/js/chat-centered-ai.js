/**
 * Sistema de Chat Centrado para IAs
 * El chat es el centro de control donde el profesional solicita asistencia
 */

class ChatCenteredAI {
    constructor() {
        this.isInitialized = false;
        this.availableCommands = {
            'buscar': this.handleSearchRequest,
            'analizar': this.handleAnalysisRequest,
            'recomendar': this.handleRecommendationRequest,
            'evaluar': this.handleEvaluationRequest,
            'ayuda': this.handleHelpRequest
        };

        this.init();
    }

    init() {
        console.log('ü§ñ Inicializando ChatCenteredAI...');

        // Esperar a que el formulario est√© disponible
        this.waitForFormObserver();
    }

    waitForFormObserver() {
        const checkInterval = setInterval(() => {
            if (window.formObserverAI) {
                clearInterval(checkInterval);
                this.setupChat();
                this.isInitialized = true;
                console.log('‚úÖ ChatCenteredAI inicializado');
            }
        }, 100);

        // Timeout despu√©s de 10 segundos
        setTimeout(() => {
            if (!this.isInitialized) {
                clearInterval(checkInterval);
                console.warn('‚ö†Ô∏è FormObserverAI no disponible, inicializando sin contexto');
                this.setupChat();
                this.isInitialized = true;
            }
        }, 10000);
    }

    setupChat() {
        // Configurar el chat para procesar comandos
        this.setupMessageHandler();
        this.setupCommandSuggestions();
        this.showWelcomeMessage();
    }

    setupMessageHandler() {
        // Esperar a que la funci√≥n agregarMensajeCopilot est√© disponible
        const waitForFunction = () => {
            if (typeof window.agregarMensajeCopilot === 'function') {
                console.log('‚úÖ Funci√≥n agregarMensajeCopilot encontrada, configurando interceptaci√≥n...');

                // Guardar la funci√≥n original
                const originalAddMessage = window.agregarMensajeCopilot;

                // Interceptar la funci√≥n
                window.agregarMensajeCopilot = (mensaje, tipo) => {
                    console.log('üîç Interceptando mensaje:', mensaje, 'tipo:', tipo);

                    if (tipo === 'user' && this.isCommand(mensaje)) {
                        console.log('ü§ñ Comando detectado, procesando...');
                        this.processCommand(mensaje);
                        return;
                    }

                    // Llamar a la funci√≥n original
                    originalAddMessage(mensaje, tipo);
                };

                console.log('‚úÖ Interceptaci√≥n configurada correctamente');
            } else {
                console.log('‚è≥ Esperando funci√≥n agregarMensajeCopilot...');
                setTimeout(waitForFunction, 100);
            }
        };

        // Iniciar la espera
        waitForFunction();
    }

    isCommand(mensaje) {
        const lowerMessage = mensaje.toLowerCase();

        // Comandos espec√≠ficos para b√∫squeda
        if (lowerMessage.includes('busca papers') ||
            lowerMessage.includes('buscar papers') ||
            lowerMessage.includes('papers sobre') ||
            lowerMessage.includes('evidencia cient√≠fica') ||
            lowerMessage.includes('estudios sobre')) {
            return true;
        }

        // Otros comandos
        return Object.keys(this.availableCommands).some(cmd =>
            lowerMessage.includes(cmd)
        );
    }

    processCommand(mensaje) {
        console.log('üîç Procesando comando:', mensaje);

        const lowerMessage = mensaje.toLowerCase();

        // Comandos espec√≠ficos para b√∫squeda
        if (lowerMessage.includes('busca papers') ||
            lowerMessage.includes('buscar papers') ||
            lowerMessage.includes('papers sobre') ||
            lowerMessage.includes('evidencia cient√≠fica') ||
            lowerMessage.includes('estudios sobre')) {
            console.log('üîç Comando de b√∫squeda detectado');
            this.handleSearchRequest(mensaje);
            return;
        }

        // Determinar qu√© comando ejecutar
        for (const [command, handler] of Object.entries(this.availableCommands)) {
            if (lowerMessage.includes(command)) {
                handler.call(this, mensaje);
                return;
            }
        }

        // Si no es un comando reconocido, mostrar ayuda
        this.handleHelpRequest(mensaje);
    }

    async handleSearchRequest(mensaje) {
        const context = this.getFormContext();
        console.log('üîç Contexto del formulario:', context);

        // Extraer tema de b√∫squeda del mensaje
        const searchTopic = this.extractSearchTopic(mensaje);
        console.log('üîç Tema de b√∫squeda extra√≠do:', searchTopic);

        if (!context.hasSufficientContext) {
            this.showMessage('‚ö†Ô∏è Necesito m√°s informaci√≥n del caso cl√≠nico para buscar papers. Por favor, completa el motivo de consulta y tipo de atenci√≥n.', 'warning');
            return;
        }

        this.showMessage(`üîç Buscando papers cient√≠ficos sobre: ${searchTopic}...`, 'info');

        try {
            const searchContext = context.getScientificSearchContext();
            // Usar el tema extra√≠do del mensaje en lugar del contexto del formulario
            searchContext.consulta = searchTopic;
            console.log('üîç Contexto de b√∫squeda:', searchContext);

            const response = await this.performScientificSearch(searchContext);

            if (response.success && response.evidence && response.evidence.length > 0) {
                this.displaySearchResults(response.evidence);
            } else {
                this.showMessage('‚ùå No se encontraron papers relevantes para este caso.', 'warning');
            }
        } catch (error) {
            console.error('Error en b√∫squeda:', error);
            this.showMessage('‚ùå Error al buscar papers cient√≠ficos.', 'error');
        }
    }

    extractSearchTopic(mensaje) {
        const lowerMessage = mensaje.toLowerCase();

        // Patrones para extraer el tema de b√∫squeda
        const patterns = [
            /busca papers de (.+)/i,
            /buscar papers de (.+)/i,
            /papers sobre (.+)/i,
            /evidencia cient√≠fica de (.+)/i,
            /estudios sobre (.+)/i,
            /busca papers (.+)/i,
            /buscar papers (.+)/i
        ];

        for (const pattern of patterns) {
            const match = mensaje.match(pattern);
            if (match && match[1]) {
                return match[1].trim();
            }
        }

        // Si no se encuentra un patr√≥n espec√≠fico, usar el mensaje completo
        return mensaje.replace(/busca papers|buscar papers|papers sobre|evidencia cient√≠fica|estudios sobre/gi, '').trim();
    }

    async handleAnalysisRequest(mensaje) {
        const context = this.getFormContext();

        if (!context.hasSufficientContext) {
            this.showMessage('‚ö†Ô∏è Necesito m√°s informaci√≥n del caso cl√≠nico para realizar el an√°lisis. Por favor, completa el motivo de consulta.', 'warning');
            return;
        }

        this.showMessage('üß† Analizando el caso cl√≠nico...', 'info');

        try {
            const analysisContext = context.getContextSummary();
            const response = await this.performClinicalAnalysis(analysisContext);

            if (response.success) {
                this.displayAnalysisResults(response);
            } else {
                this.showMessage('‚ùå Error al analizar el caso cl√≠nico.', 'error');
            }
        } catch (error) {
            console.error('Error en an√°lisis:', error);
            this.showMessage('‚ùå Error al realizar el an√°lisis cl√≠nico.', 'error');
        }
    }

    async handleRecommendationRequest(mensaje) {
        const context = this.getFormContext();

        if (!context.hasSufficientContext) {
            this.showMessage('‚ö†Ô∏è Necesito m√°s informaci√≥n del caso cl√≠nico para generar recomendaciones.', 'warning');
            return;
        }

        this.showMessage('üí° Generando recomendaciones cl√≠nicas...', 'info');

        try {
            const recommendationContext = context.getContextSummary();
            const response = await this.generateRecommendations(recommendationContext);

            if (response.success) {
                this.displayRecommendations(response.recommendations);
            } else {
                this.showMessage('‚ùå Error al generar recomendaciones.', 'error');
            }
        } catch (error) {
            console.error('Error en recomendaciones:', error);
            this.showMessage('‚ùå Error al generar recomendaciones cl√≠nicas.', 'error');
        }
    }

    async handleEvaluationRequest(mensaje) {
        const context = this.getFormContext();

        if (!context.hasSufficientContext) {
            this.showMessage('‚ö†Ô∏è Necesito m√°s informaci√≥n del caso cl√≠nico para realizar la evaluaci√≥n.', 'warning');
            return;
        }

        this.showMessage('üìä Evaluando el caso cl√≠nico...', 'info');

        try {
            const evaluationContext = context.getContextSummary();
            const response = await this.performEvaluation(evaluationContext);

            if (response.success) {
                this.displayEvaluationResults(response);
            } else {
                this.showMessage('‚ùå Error al realizar la evaluaci√≥n.', 'error');
            }
        } catch (error) {
            console.error('Error en evaluaci√≥n:', error);
            this.showMessage('‚ùå Error al realizar la evaluaci√≥n cl√≠nica.', 'error');
        }
    }

    handleHelpRequest(mensaje) {
        const helpMessage = `
ü§ñ **Comandos disponibles:**

üîç **Buscar papers cient√≠ficos:**
- "buscar papers sobre [tema]"
- "buscar evidencia cient√≠fica"
- "necesito papers sobre [condici√≥n]"

üß† **Analizar caso cl√≠nico:**
- "analizar el caso"
- "analizar la situaci√≥n"
- "necesito an√°lisis del caso"

üí° **Generar recomendaciones:**
- "recomendar tratamiento"
- "dar recomendaciones"
- "sugerir intervenciones"

üìä **Evaluar caso:**
- "evaluar el caso"
- "hacer evaluaci√≥n"
- "valorar la situaci√≥n"

‚ùì **Ayuda:**
- "ayuda"
- "comandos disponibles"
- "qu√© puedo hacer"
        `;

        this.showMessage(helpMessage, 'info');
    }

    getFormContext() {
        // Obtener datos directamente del formulario
        const getFormData = () => {
            const formData = {
                motivoConsulta: document.getElementById('motivoConsulta')?.value || '',
                tipoAtencion: document.getElementById('tipoAtencion')?.value || '',
                pacienteNombre: document.getElementById('pacienteNombre')?.value || '',
                pacienteRut: document.getElementById('pacienteRut')?.value || '',
                pacienteEdad: document.getElementById('pacienteEdad')?.value || '',
                antecedentes: document.getElementById('antecedentes')?.value || '',
                evaluacion: document.getElementById('evaluacion')?.value || '',
                diagnostico: document.getElementById('diagnostico')?.value || '',
                tratamiento: document.getElementById('tratamiento')?.value || '',
                observaciones: document.getElementById('observaciones')?.value || ''
            };
            return formData;
        };

        const formData = getFormData();
        const hasSufficientContext = !!(formData.motivoConsulta && formData.tipoAtencion);

        return {
            hasSufficientContext: hasSufficientContext,
            getContextSummary: () => ({
                paciente: {
                    nombre: formData.pacienteNombre,
                    edad: formData.pacienteEdad
                },
                consulta: {
                    motivo: formData.motivoConsulta,
                    tipo: formData.tipoAtencion
                },
                clinico: {
                    antecedentes: formData.antecedentes,
                    evaluacion: formData.evaluacion,
                    diagnostico: formData.diagnostico
                }
            }),
            getScientificSearchContext: () => ({
                consulta: formData.motivoConsulta,
                tipoAtencion: formData.tipoAtencion,
                antecedentes: formData.antecedentes,
                evaluacion: formData.evaluacion,
                diagnostico: formData.diagnostico
            })
        };
    }

    async performScientificSearch(context) {
        console.log('üîç Enviando b√∫squeda cient√≠fica:', context);

        const response = await fetch('/api/copilot/search-enhanced', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                motivo_consulta: context.consulta,
                contexto_clinico: context
            })
        });

        const data = await response.json();
        console.log('üìä Respuesta de b√∫squeda cient√≠fica:', data);
        return data;
    }

    async performClinicalAnalysis(context) {
        console.log('üß† Enviando an√°lisis cl√≠nico:', context);

        const response = await fetch('/api/copilot/analyze-enhanced', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                consulta: context.consulta?.motivo || 'An√°lisis cl√≠nico',
                contexto_clinico: context
            })
        });

        const data = await response.json();
        console.log('üìä Respuesta de an√°lisis cl√≠nico:', data);
        return data;
    }

    async generateRecommendations(context) {
        // Usar el sistema de an√°lisis cl√≠nico para generar recomendaciones
        return await this.performClinicalAnalysis(context);
    }

    async performEvaluation(context) {
        // Usar el sistema de an√°lisis cl√≠nico para evaluaci√≥n
        return await this.performClinicalAnalysis(context);
    }

    displaySearchResults(evidence) {
        let message = 'üìö **Papers cient√≠ficos encontrados:**\n\n';

        evidence.slice(0, 5).forEach((paper, index) => {
            message += `**${index + 1}. ${paper.titulo || paper.title}**\n`;
            message += `üìÖ A√±o: ${paper.year || paper.a√±o_publicacion || 'N/A'}\n`;
            message += `üìä Tipo: ${paper.tipo || paper.tipo_evidencia || 'Estudio'}\n`;
            message += `üìà Relevancia: ${Math.round((paper.relevancia || paper.relevancia_score || 0) * 100)}%\n`;

            // Mostrar DOI si existe y no es "Sin DOI"
            if (paper.doi && paper.doi !== "Sin DOI") {
                message += `üîó DOI: ${paper.doi}\n`;
            }

            // Mostrar cita APA si existe
            if (paper.cita_apa) {
                message += `üìñ **Cita APA:** ${paper.cita_apa}\n`;
            }

            message += `üìù ${(paper.resumen || paper.abstract || '').substring(0, 150)}...\n\n`;
        });

        this.showMessage(message, 'success');
    }

    displayAnalysisResults(response) {
        let message = 'üß† **An√°lisis cl√≠nico completado:**\n\n';

        if (response.nlp_analysis) {
            const nlp = response.nlp_analysis;
            message += `üîë **Palabras clave:** ${nlp.palabras_clave?.join(', ') || 'No identificadas'}\n`;
            message += `üìù **S√≠ntomas:** ${nlp.sintomas?.join(', ') || 'No identificados'}\n`;
            message += `üè• **Entidades:** ${nlp.entidades?.join(', ') || 'No identificadas'}\n`;
            message += `üìä **Confianza:** ${Math.round((nlp.confianza || 0) * 100)}%\n\n`;
        }

        if (response.clinical_analysis?.recomendaciones) {
            message += 'üí° **Recomendaciones:**\n';
            response.clinical_analysis.recomendaciones.forEach(rec => {
                message += `‚Ä¢ ${rec}\n`;
            });
        }

        this.showMessage(message, 'success');
    }

    displayRecommendations(recommendations) {
        let message = 'üí° **Recomendaciones cl√≠nicas:**\n\n';

        if (Array.isArray(recommendations)) {
            recommendations.forEach(rec => {
                message += `‚Ä¢ ${rec}\n`;
            });
        } else if (typeof recommendations === 'string') {
            message += recommendations;
        }

        this.showMessage(message, 'success');
    }

    displayEvaluationResults(response) {
        let message = 'üìä **Evaluaci√≥n cl√≠nica completada:**\n\n';

        if (response.clinical_analysis) {
            const clinical = response.clinical_analysis;

            if (clinical.patologias?.length > 0) {
                message += 'üè• **Patolog√≠as identificadas:**\n';
                clinical.patologias.forEach(pat => {
                    message += `‚Ä¢ ${pat}\n`;
                });
                message += '\n';
            }

            if (clinical.escalas?.length > 0) {
                message += 'üìä **Escalas recomendadas:**\n';
                clinical.escalas.forEach(esc => {
                    message += `‚Ä¢ ${esc}\n`;
                });
                message += '\n';
            }

            if (clinical.recomendaciones?.length > 0) {
                message += 'üí° **Recomendaciones:**\n';
                clinical.recomendaciones.forEach(rec => {
                    message += `‚Ä¢ ${rec}\n`;
                });
            }
        }

        this.showMessage(message, 'success');
    }

    showMessage(mensaje, tipo = 'info') {
        if (window.agregarMensajeCopilot) {
            window.agregarMensajeCopilot(mensaje, tipo);
        } else {
            console.log(`[${tipo.toUpperCase()}] ${mensaje}`);
        }
    }

    showWelcomeMessage() {
        const welcomeMessage = `
ü§ñ **¬°Hola! Soy tu asistente IA cl√≠nico.**

Estoy observando el formulario y puedo ayudarte con:

üîç **B√∫squeda de papers cient√≠ficos**
üß† **An√°lisis de casos cl√≠nicos**  
üí° **Recomendaciones de tratamiento**
üìä **Evaluaciones cl√≠nicas**

**Para empezar, escribe:**
- "ayuda" - para ver todos los comandos
- "buscar papers sobre [tema]" - para buscar evidencia cient√≠fica
- "analizar el caso" - para an√°lisis cl√≠nico completo

**Importante:** Completa el formulario con la informaci√≥n del paciente para obtener mejores resultados.
        `;

        this.showMessage(welcomeMessage, 'info');
    }

    setupCommandSuggestions() {
        // Agregar sugerencias de comandos al chat
        const suggestions = [
            'buscar papers',
            'analizar caso',
            'recomendar tratamiento',
            'evaluar paciente',
            'ayuda'
        ];

        // Exponer sugerencias para el UI
        window.chatCommandSuggestions = suggestions;
    }
}

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        window.chatCenteredAI = new ChatCenteredAI();
    });
} else {
    window.chatCenteredAI = new ChatCenteredAI();
} 