#!/usr/bin/env python3
"""
Script robusto para crear usuarios en Railway PostgreSQL
"""

import os
import psycopg2
from psycopg2.extras import RealDictCursor
import bcrypt
import requests
import sys


def get_railway_database_url():
    """Obtiene la URL de la base de datos de Railway"""

    # Intentar diferentes formas de obtener la URL
    database_url = os.environ.get("DATABASE_URL")

    if not database_url:
        # Construir URL desde variables individuales
        pghost = os.environ.get("PGHOST")
        pgport = os.environ.get("PGPORT")
        pgdatabase = os.environ.get("PGDATABASE")
        pguser = os.environ.get("PGUSER")
        pgpassword = os.environ.get("PGPASSWORD")

        if all([pghost, pgport, pgdatabase, pguser, pgpassword]):
            database_url = (
                f"postgresql://{pguser}:{pgpassword}@{pghost}:{pgport}/{pgdatabase}"
            )
        else:
            # URL hardcodeada como fallback
            database_url = "postgresql://postgres:SBbyfurhbJUJsFbelYJCcOvkSpXDCNZd@hopper.proxy.rlwy.net:51396/railway"

    return database_url


def create_railway_users_robust():
    """Crea usuarios de prueba en Railway PostgreSQL de forma robusta"""

    print("üîÑ Creando usuarios de prueba en Railway PostgreSQL...")
    print("=" * 60)

    # Obtener URL de base de datos
    database_url = get_railway_database_url()

    print(f"üîó Conectando a Railway PostgreSQL...")
    print(f"   URL: {database_url[:50]}...")

    try:
        # Conectar a PostgreSQL con configuraci√≥n robusta
        conn = psycopg2.connect(
            database_url,
            connect_timeout=10,
            application_name="medconnect_user_creation",
        )
        cursor = conn.cursor(cursor_factory=RealDictCursor)

        print("‚úÖ Conexi√≥n a PostgreSQL exitosa")

        # Verificar conexi√≥n
        cursor.execute("SELECT version();")
        version = cursor.fetchone()[0]
        print(f"üìä PostgreSQL version: {version[:50]}...")

        # Verificar si la tabla usuarios existe
        cursor.execute(
            """
            SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name = 'usuarios'
            );
        """
        )

        table_exists = cursor.fetchone()[0]
        print(f"üìã Tabla usuarios existe: {table_exists}")

        if not table_exists:
            print("üîß Creando tabla usuarios...")

            # Crear tabla usuarios
            cursor.execute(
                """
                CREATE TABLE usuarios (
                    id SERIAL PRIMARY KEY,
                    email VARCHAR(255) UNIQUE NOT NULL,
                    password_hash VARCHAR(255) NOT NULL,
                    nombre VARCHAR(100) NOT NULL,
                    apellido VARCHAR(100) NOT NULL,
                    tipo_usuario VARCHAR(20) DEFAULT 'paciente',
                    telefono VARCHAR(20),
                    especialidad VARCHAR(100),
                    activo BOOLEAN DEFAULT true,
                    fecha_creacion TIMESTAMP DEFAULT NOW(),
                    ultimo_acceso TIMESTAMP
                );
            """
            )

            print("‚úÖ Tabla usuarios creada")

        # Usuarios de prueba
        test_users = [
            {
                "email": "diego.castro.lagos@gmail.com",
                "password": "password123",
                "nombre": "Diego",
                "apellido": "Castro",
                "tipo_usuario": "profesional",
                "telefono": "+56912345678",
                "especialidad": "Medicina General",
            },
            {
                "email": "rodrigoandressilvabreve@gmail.com",
                "password": "password123",
                "nombre": "Rodrigo",
                "apellido": "Silva",
                "tipo_usuario": "paciente",
                "telefono": "+56987654321",
                "especialidad": None,
            },
        ]

        print(f"\nüë• Procesando {len(test_users)} usuarios de prueba...")

        for i, user in enumerate(test_users, 1):
            print(f"\nüîê [{i}/{len(test_users)}] Procesando: {user['email']}")

            try:
                # Verificar si el usuario ya existe
                cursor.execute(
                    "SELECT id, email FROM usuarios WHERE email = %s", (user["email"],)
                )
                existing = cursor.fetchone()

                if existing:
                    print(
                        f"  ‚ö†Ô∏è Usuario ya existe (ID: {existing['id']}) - actualizando..."
                    )

                    # Actualizar usuario existente
                    password_hash = bcrypt.hashpw(
                        user["password"].encode("utf-8"), bcrypt.gensalt()
                    ).decode("utf-8")

                    cursor.execute(
                        """
                        UPDATE usuarios SET
                            password_hash = %s,
                            nombre = %s,
                            apellido = %s,
                            tipo_usuario = %s,
                            telefono = %s,
                            especialidad = %s,
                            activo = true
                        WHERE email = %s
                    """,
                        (
                            password_hash,
                            user["nombre"],
                            user["apellido"],
                            user["tipo_usuario"],
                            user["telefono"],
                            user["especialidad"],
                            user["email"],
                        ),
                    )

                    print(f"  ‚úÖ Usuario actualizado")
                else:
                    print(f"  ‚ûï Creando nuevo usuario...")

                    # Hash de la contrase√±a
                    password_hash = bcrypt.hashpw(
                        user["password"].encode("utf-8"), bcrypt.gensalt()
                    ).decode("utf-8")

                    # Insertar usuario
                    cursor.execute(
                        """
                        INSERT INTO usuarios (
                            email, password_hash, nombre, apellido, tipo_usuario,
                            telefono, especialidad, activo, fecha_creacion
                        ) VALUES (
                            %s, %s, %s, %s, %s, %s, %s, %s, NOW()
                        )
                    """,
                        (
                            user["email"],
                            password_hash,
                            user["nombre"],
                            user["apellido"],
                            user["tipo_usuario"],
                            user["telefono"],
                            user["especialidad"],
                            True,
                        ),
                    )

                    print(f"  ‚úÖ Usuario creado")

            except Exception as e:
                print(f"  ‚ùå Error procesando usuario {user['email']}: {e}")
                continue

        # Confirmar cambios
        conn.commit()
        print(f"\n‚úÖ Cambios confirmados en la base de datos")

        # Verificar usuarios creados
        print(f"\nüîç Verificando usuarios en la base de datos...")
        cursor.execute(
            """
            SELECT email, nombre, apellido, tipo_usuario, activo, fecha_creacion
            FROM usuarios 
            WHERE email IN ('diego.castro.lagos@gmail.com', 'rodrigoandressilvabreve@gmail.com')
            ORDER BY email
        """
        )

        users = cursor.fetchall()
        print(f"üìã Usuarios encontrados: {len(users)}")

        for user in users:
            status = "‚úÖ Activo" if user["activo"] else "‚ùå Inactivo"
            created = (
                user["fecha_creacion"].strftime("%Y-%m-%d %H:%M")
                if user["fecha_creacion"]
                else "N/A"
            )
            print(
                f"  - {user['email']} ({user['tipo_usuario']}) - {status} - Creado: {created}"
            )

        cursor.close()
        conn.close()

        print(f"\nüéâ Usuarios de prueba creados exitosamente en Railway")
        return True

    except psycopg2.OperationalError as e:
        print(f"‚ùå Error de conexi√≥n a PostgreSQL: {e}")
        print(f"üîß Verifica que la base de datos est√© disponible")
        return False
    except psycopg2.Error as e:
        print(f"‚ùå Error de PostgreSQL: {e}")
        return False
    except Exception as e:
        print(f"‚ùå Error inesperado: {e}")
        return False


def test_railway_login_final():
    """Prueba final del login en Railway"""

    print(f"\nüß™ PRUEBA FINAL - Login en Railway...")
    print("=" * 50)

    # URL de login
    login_url = "https://www.medconnect.cl/login"

    # Datos de prueba
    test_credentials = [
        {
            "email": "diego.castro.lagos@gmail.com",
            "password": "password123",
            "expected_type": "profesional",
        },
        {
            "email": "rodrigoandressilvabreve@gmail.com",
            "password": "password123",
            "expected_type": "paciente",
        },
    ]

    success_count = 0

    for creds in test_credentials:
        print(f"\nüîê Probando login con: {creds['email']}")

        try:
            # Crear sesi√≥n
            session = requests.Session()

            # Obtener p√°gina de login
            response = session.get(login_url, timeout=10)

            if response.status_code != 200:
                print(f"  ‚ùå Error obteniendo p√°gina de login: {response.status_code}")
                continue

            print(f"  ‚úÖ P√°gina de login cargada correctamente")

            # Intentar login
            login_data = {"email": creds["email"], "password": creds["password"]}

            login_response = session.post(
                login_url, data=login_data, allow_redirects=False, timeout=10
            )

            print(f"  üìä Status del login: {login_response.status_code}")

            if login_response.status_code == 302:
                redirect_url = login_response.headers.get("Location", "")
                print(f"  ‚úÖ Login exitoso - Redirigiendo a: {redirect_url}")

                # Verificar redirecci√≥n
                if "/professional" in redirect_url:
                    print(f"  ‚úÖ Redirecci√≥n correcta para profesional")
                elif "/patient" in redirect_url:
                    print(f"  ‚úÖ Redirecci√≥n correcta para paciente")
                else:
                    print(f"  ‚ö†Ô∏è Redirecci√≥n inesperada: {redirect_url}")

                success_count += 1

            elif login_response.status_code == 200:
                # Verificar si hay mensaje de error en el HTML
                if "Credenciales inv√°lidas" in login_response.text:
                    print(f"  ‚ùå Login fallido - Credenciales inv√°lidas")
                elif "Error" in login_response.text:
                    print(f"  ‚ùå Login fallido - Error en el sistema")
                else:
                    print(f"  ‚ö†Ô∏è Login no procesado correctamente")
            else:
                print(f"  ‚ùå Error inesperado: {login_response.status_code}")

        except Exception as e:
            print(f"  ‚ùå Error probando login: {e}")

    print(f"\n" + "=" * 50)
    print(
        f"üìä RESULTADO FINAL: {success_count}/{len(test_credentials)} logins exitosos"
    )

    if success_count == len(test_credentials):
        print("üéâ ¬°TODOS LOS LOGINS EXITOSOS!")
        print("‚úÖ El problema de login en Railway est√° SOLUCIONADO")
    elif success_count > 0:
        print("‚ö†Ô∏è LOGIN PARCIALMENTE EXITOSO")
        print("üîß Algunos usuarios funcionan, otros pueden necesitar verificaci√≥n")
    else:
        print("‚ùå NING√öN LOGIN EXITOSO")
        print("üîß Revisa la configuraci√≥n de la base de datos")

    return success_count == len(test_credentials)


if __name__ == "__main__":
    print("üöÄ SOLUCI√ìN ROBUSTA RAILWAY USERS")
    print("=" * 60)

    success = create_railway_users_robust()

    if success:
        test_railway_login_final()
        print(f"\nüéâ ¬°PROCESO COMPLETADO!")
        print(f"üîß Ahora puedes probar el login en https://www.medconnect.cl/login")
        print(f"üìß Credenciales:")
        print(f"   - diego.castro.lagos@gmail.com / password123")
        print(f"   - rodrigoandressilvabreve@gmail.com / password123")
    else:
        print(f"\n‚ùå Error en el proceso")
        print(f"üîß Revisa la conexi√≥n a la base de datos")
        sys.exit(1)
